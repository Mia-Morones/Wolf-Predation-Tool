"use strict";(self.webpackChunkreact_redux_arcgis_boilerplate=self.webpackChunkreact_redux_arcgis_boilerplate||[]).push([[5423],{34393:function(e,t,s){s.d(t,{$1:function(){return u},H2:function(){return d},MT:function(){return m},VP:function(){return g},WF:function(){return l},Wt:function(){return a},XQ:function(){return h},hK:function(){return f},nS:function(){return p},uh:function(){return i},xY:function(){return c}});var r=s(62991);const n="upload-assets",o=()=>new Error;class a extends r.A{constructor(){super(`${n}:unsupported`,"Layer does not support asset uploads.",o())}}class i extends r.A{constructor(){super(`${n}:no-glb-support`,"Layer does not support glb.",o())}}class c extends r.A{constructor(){super(`${n}:no-supported-source`,"No supported external source found",o())}}class u extends r.A{constructor(){super(`${n}:not-base-64`,"Expected gltf data in base64 format after conversion.",o())}}class l extends r.A{constructor(){super(`${n}:unable-to-prepare-options`,"Unable to prepare uploadAsset request options.",o())}}class p extends r.A{constructor(e,t){super(`${n}:bad-response`,`Bad response. Uploaded ${e} items and received ${t} results.`,o())}}class f extends r.A{constructor(e,t){super(`${n}-layer:upload-failed`,`Failed to upload mesh file ${e}. Error code: ${t?.code??"-1"}. Error message: ${t?.messages??"unknown"}`,o())}}class d extends r.A{constructor(e){super(`${n}-layer:unsupported-format`,`The service allowed us to upload an asset of FormatID ${e}, but it does not list it in its supported formats.`,o())}}class m extends r.A{constructor(){super(`${n}:convert3D-failed`,"convert3D failed.")}}class g extends r.A{constructor(){super("invalid-input:no-model","No supported model found")}}class h extends r.A{constructor(){super("invalid-input:multiple-models","Multiple supported models found")}}},25423:function(e,t,s){s.d(t,{uploadAssets:function(){return R}});s(3313);var r=s(38116),n=s(6273),o=s(80861),a=s(37623),i=s(67900),c=s(19759),u=s(1874),l=s(28936),p=s(34393);const f={upload:{createFromFiles:.8,loadMesh:.2},uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};var d=s(63457),m=s(70214),g=s(80294);function h(e,t=e=>{},s){return new w(e,t,s)}class w{constructor(e,t=e=>{},s){if(this.onProgress=t,this.taskName=s,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,"number"==typeof e){this._weights={};for(let t=0;t<e;t++){const s=t,r=1/e;this._weights[s]=r,this._progressMap.set(s,0)}}else this._weights=e;this.emitProgress()}emitProgress(){let e=0;for(const[t,s]of this._progressMap.entries())e+=s*this._weights[t];if(1===e&&(0,n.A)("enable-feature:esri-3dofl-upload-timings")){const e=Math.round(performance.now()-(this._startTime??0))/1e3;for(const[t,s]of this._timingsMap){const t=Math.round(s.end-s.start)/1e3;Math.round(t/e*100)}}this.onProgress(e)}setProgress(e,t){if(this._progressMap.set(e,t),(0,n.A)("enable-feature:esri-3dofl-upload-timings")){const s=performance.now();this._startTime??=s;const r=(0,g.tE)(this._timingsMap,e,(()=>({start:s,end:0})));1===t&&(r.end=s)}this.emitProgress()}simulate(e,t){return y((t=>this.setProgress(e,t)),t)}makeOnProgress(e){return t=>this.setProgress(e,t)}}function y(e=e=>{},t=x){const s=performance.now();e(0);const r=setInterval((()=>{const r=performance.now()-s,n=1-Math.exp(-r/t);e(n)}),v);return(0,m.hA)((()=>{clearInterval(r),e(1)}))}function A(e,t=T){return(0,i.gr)((0,i.Kp)(e*P/t))}const T=10,b=10,P=8e-6,v=(0,i.l5)(50),x=(0,i.l5)(1e3),j=1e6,F=20*j,_=2e9,D=3;async function M({data:e,name:t,description:s},n,o){let i=null;try{const l=(0,c.fj)(n,"uploads"),p=(0,c.fj)(l,"info"),{data:f}=await(0,r.A)(p,{query:{f:"json"},responseType:"json"});(0,a.Te)(o);const m=(0,d.Wo)(n),g=f.maxUploadFileSize*j,w=m?_:g,y=m?Math.min(F,g):F;if(e.size>w)throw new Error("Data too large");const T=(0,c.fj)(l,"register"),{data:b}=await(0,r.A)(T,{query:{f:"json",itemName:(u=t,u.replaceAll("/","_").replaceAll("\\","_")),description:s},responseType:"json",method:"post"});if((0,a.Te)(o),!b.success)throw new Error("Registration failed");const{itemID:P}=b.item;i=(0,c.fj)(l,P);const v=(0,c.fj)(i,"uploadPart"),x=Math.ceil(e.size/y),M=new Array;for(let t=0;t<x;++t)M.push(e.slice(t*y,Math.min((t+1)*y,e.size)));const S=M.slice().reverse(),$=new Array,E=h(x,o?.onProgress,"uploadItem"),N=async()=>{for(;0!==S.length;){const e=M.length-S.length,t=S.pop(),s=new FormData,n=E.simulate(e,A(t.size));try{s.append("f","json"),s.append("file",t),s.append("partId",`${e}`);const{data:n}=await(0,r.A)(v,{timeout:0,body:s,responseType:"json",method:"post"});if((0,a.Te)(o),!n.success)throw new Error("Part upload failed")}finally{n.remove()}}};for(let e=0;e<D&&0!==S.length;++e)$.push(N());await Promise.all($);const R=(0,c.fj)(i,"commit"),{data:k}=await(0,r.A)(R,{query:{f:"json",parts:M.map(((e,t)=>t)).join(",")},responseType:"json",method:"post"});if((0,a.Te)(o),!k.success)throw new Error("Commit failed");return k.item}catch(e){if(null!=i){const e=(0,c.fj)(i,"delete");await(0,r.A)(e,{query:{f:"json"},responseType:"json",method:"post"})}throw e}var u}var S=s(52360),$=s(91477),E=s(74108),N=s(44153);async function R(e,t,s){const r=e.length;if(!r)return s?.onProgress?.(1),[];const o=h(r,s?.onProgress,"uploadAssets");return Promise.all(e.map(((e,r)=>async function(e,{layer:t,ongoingUploads:s},r){const o=s.get(e);if(o)return o;if(!function(e){return!!e.infoFor3D&&!!e.url}(t))throw new p.Wt;if(function(e,t){const{parsedUrl:s}=t;return null!=s&&e.metadata.externalSources.some((e=>(0,l.eN)(e,s)))}(e,t))return r?.onProgress?.(1),e;const d=async function(e,t,s){const{metadata:r}=e,{displaySource:o}=r,d=k(o?.source,t,{checkForConversionRequired:(0,n.A)("enable-feature:georeferenced-uploads")}),m=null!=d?async function(e,t,s){return{source:await C(e,t,s),original:!0,unitConversionDisabled:!0}}(d,t,s):r.externalSources.length>0?async function(e,t,s){const r=q(t),{externalSources:o}=e.metadata,a=function(e,t){for(const s of e){const e=k(s.source,t);if(e)return e}return null}(o,t);if(!a)throw new p.xY;const u=h(f.uploadConvertibleSource,s?.onProgress,"uploadConvertibleSource"),d=await C(a,t,{onProgress:u.makeOnProgress("uploadEditSource")});e.addExternalSources([{source:d,original:!0}]);const m=a.reduce(((e,{asset:t})=>t instanceof File?e+t.size:e),0),g=u.simulate("serviceAssetsToGlb",function(e,t=b){return(0,i.gr)((0,i.Kp)(e*P/t))}(m));try{const{source:o,transform:a,origin:i}=await async function(e,t,s){const r=e.map((({assetName:e,parts:t})=>({assetName:e,assetHash:t[0].partHash})));let o;try{const e=(0,c.fj)(t.parsedUrl.path,"convert3D"),n=t.capabilities?.operations.supportsAsyncConvert3D;o=(await(n?Z:Y)(e,{query:{f:"json",assets:JSON.stringify(r),transportType:"esriTransportTypeUrl",targetFormat:s,async:n},responseType:"json",timeout:0})).data}catch(e){throw new p.MT}return function(e,t){const s={source:t.assets.map((t=>{const s=(0,S.R_)(t.contentType,e.infoFor3D.supportedFormats);if(!s)throw new p.H2(s);return new l.Qp(t.assetName,t.contentType,[new l.Bq(t.assetURL,t.assetHash)])})),origin:void 0,transform:void 0};if((0,n.A)("enable-feature:georeferenced-uploads")&&t.transform){if(s.transform=(0,E.f)(t.transform),t.spatialReference){const e=N.A.fromJSON(t.spatialReference);s.origin=(0,E.V)(t.transform,e)}}else s.transform=(0,$.Z)(e.spatialReference);return s}(t,o)}(d,t,r);return e.transform=a,i&&(e.metadata.georeferenced=!0,s?.useAssetOrigin&&(e.vertexSpace.origin=[i.x,i.y,i.z??0],e.spatialReference=i.spatialReference)),{source:o,unitConversionDisabled:!0}}finally{g.remove()}}(e,t,s):async function(e,t,s){const r=h(f.uploadLocalMesh,s?.onProgress,"uploadLocalMesh"),n=async function(e,t,s){const r=q(t),n=await e.load(s),o=await n.toBinaryGLTF({origin:n.origin,signal:s?.signal,ignoreLocalTransform:!0,unitConversionDisabled:!0});return(0,a.Te)(s),{blob:new Blob([o],{type:"model/gltf-binary"}),assetName:`${(0,u.yS)()}.glb`,assetType:r}}(e,t,{...s,onProgress:r.makeOnProgress("meshToAssetBlob")});return{source:await U([n],t,{...s,onProgress:r.makeOnProgress("uploadAssetBlobs")}),extent:e.extent.clone(),original:!0}}(e,t,s),g=await m;return(0,a.Te)(s),e.addExternalSources([g]),e}(e,t,r);s.set(e,d);try{await d}finally{s.delete(e)}return e}(e,t,{...s,onProgress:o.makeOnProgress(r)}))))}function k(e,{infoFor3D:t},s={}){if(!e)return null;const{supportedFormats:r,editFormats:n}=t,o=(0,l.WN)(e),a=new Array,i=(0,S.ND)(t),c=(0,S.nr)(t);let u=!1;for(const e of o){const t=I(e,r);if(!t)return null;const{assetType:o}=t;if(s.checkForConversionRequired&&(o===i||o===c))return null;n.includes(o)&&(u=!0),a.push(t)}return u?a:null}function I(e,t){const s=(0,l.fH)(e,t);return s?{asset:e,assetType:s}:null}async function C(e,t,s){return U(e.map((e=>async function(e,t){const{asset:s,assetType:r}=e;if(s instanceof File)return{blob:s,assetName:s.name,assetType:r};const n=await s.toBlob(t);return(0,a.Te)(t),{blob:n,assetName:s.assetName,assetType:r}}(e,s))),t,s)}async function U(e,t,s){const r=h(f.uploadAssetBlobs,s?.onProgress,"uploadAssetBlobs"),n=await function(e,t,s){const r=h(e.length,s?.onProgress,"prepareAssetItems");return Promise.all(e.map((async(e,n)=>{const i=async function(e,t,s){const{blob:r,assetType:n,assetName:i}=e;let u=null;try{const e=await M({data:r,name:i},t.url,s);(0,a.Te)(s),u={assetType:n,assetUploadId:e.itemID}}catch(e){(0,a.QP)(e),o.A.getLogger("esri.layers.graphics.sources.support.uploadAssets").warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!u){const e=await(0,c._0)(r);if((0,a.Te)(s),!e.isBase64)throw new p.$1;u={assetType:n,assetData:e.data}}if(!u)throw new p.WF;return{item:u,assetName:i}}(await e,t,{...s,onProgress:r.makeOnProgress(n)});return(0,a.Te)(s),i})))}(e,t,{...s,onProgress:r.makeOnProgress("prepareAssetItems")});(0,a.Te)(s);const i=n.map((({item:e})=>e)),{uploadResults:u}=await B(i,t,{...s,onProgress:r.makeOnProgress("uploadAssetItems")});return(0,a.Te)(s),e.map(((e,s)=>function(e,t,s){const{success:r}=t;if(!r){const{error:s}=t;throw new p.hK(e.assetName,s)}const{assetHash:n}=t,{assetName:o,item:{assetType:a}}=e,{infoFor3D:{supportedFormats:i}}=s,c=(0,S.Fm)(a,i);if(!c)throw new p.H2(a);return new l.Qp(o,c,[new l.Bq(`${s.parsedUrl.path}/assets/${n}`,n)])}(n[s],u[s],t)))}async function B(e,t,s){const n=y(s?.onProgress);try{const n=await(0,r.A)((0,c.fj)(t.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(e)},method:"post",responseType:"json"});if((0,a.Te)(s),n.data.uploadResults.length!==e.length)throw new p.nS(e.length,n.data.uploadResults.length);return n.data}finally{n.remove()}}function Y(e,t){return(0,r.A)(e,t)}async function Z(e,t){const s=(await(0,r.A)(e,t)).data.statusUrl;for(;;){const e=(await(0,r.A)(s,{query:{f:"json"},responseType:"json"})).data;switch(e.status){case"Completed":return(0,r.A)(e.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(e.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}await(0,a.Pl)(O)}}function q({infoFor3D:e}){const t=(0,S.U9)(e);if(!t)throw new p.uh;return t}const O=(0,i.l5)(1e3)},91477:function(e,t,s){s.d(t,{Z:function(){return o}});var r=s(5262),n=s(77873);function o(e){const t=1/(0,r.GA)(e,1);return 1!==t?new n.A({scale:[t,t,t]}):void 0}},74108:function(e,t,s){s.d(t,{V:function(){return o},f:function(){return a}});s(3313);var r=s(77873),n=s(1912);function o(e,t,s=i){return new n.A({x:e[s.originX],y:e[s.originY],z:e[s.originZ],spatialReference:t})}function a(e,t=i){return new r.A({translation:[e[t.translationX],-e[t.translationZ],e[t.translationY]],rotationAxis:[e[t.rotationX],-e[t.rotationZ],e[t.rotationY]],rotationAngle:e[t.rotationDeg],scale:[e[t.scaleX],e[t.scaleZ],e[t.scaleY]]})}const i={originX:"originX",originY:"originY",originZ:"originZ",translationX:"translationX",translationY:"translationY",translationZ:"translationZ",scaleX:"scaleX",scaleY:"scaleY",scaleZ:"scaleZ",rotationX:"rotationX",rotationY:"rotationY",rotationZ:"rotationZ",rotationDeg:"rotationDeg"}}}]);
//# sourceMappingURL=5423.21b602fbbf88f611db07.js.map